
@{
    ViewBag.Title = "BulkPayout";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/AdminLTE/tabulator-master/dist/css/tabulator.min.css" rel="stylesheet" type="text/css" media="all" />

@section Styles
{
    <style>
        .panel-body {
            padding: 0 !important;
            background-color: white;
        }

        .form-group {
            margin-left: 3px !important;
            margin-bottom: 3px !important;
        }

        .form-horizontal {
            padding: 3px !important;
            margin: 3px !important;
        }

        .padding-0 {
            padding-right: 3px;
            padding-left: 3px;
        }

        .panel-footer {
            padding: 0 !important;
        }

        .tabulator-footer {
            text-align: center !important;
        }
    </style>
}
<div id="divModalProgress" class="modal" style="display: none">
    <div class="center">
        <img alt="" src="~/img/loader.gif" />
    </div>
</div>

<div class="container">
    <div class="row ">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <div class="panel-group">
                <div class="panel panel-info">
                    <div id="divRMSHead" style="height: 28px;padding:6px; font-family:Verdana; font-size:12px; font-weight:800; text-align:center" class="panel-heading">
                        <strong>FUND PAYOUT</strong>
                    </div>
                </div>
                <div class="panel-body">
                    @using (Html.BeginForm())
                    {
                        <div class="form-horizontal">
                            <div class="form-group form-group-sm">
                                <div class="col-md-3 padding-0">
                                </div>
                                <div class="col-md-2 padding-0 ">
                                    <select id='cmbSelect' class="form-control input-sm">
                                        <option value='ALL'>All</option>
                                        <option value='CL'>Client</option>
                                        <option value='GR'>Group</option>
                                        <option value='SB'>Sub-Broker</option>
                                        <option value='FM'>Family</option>
                                        <option value='BR'>Branch</option>
                                    </select>
                                </div>
                                <div class="col-md-6 padding-0">
                                    <input type="text" class="form-control input-sm" id="txtSearchbyName" style="display:none" placeholder="Search Client" list="ClientMasterSearch">
                                    <datalist id="ClientMasterSearch"></datalist>
                                </div>
                            
                            </div>
                            <div class="form-group form-group-sm">
                                <div class="col-md-1 padding-0">
                                </div>
                                <div class="col-md-2 padding-0" style="text-align:right">
                                    As on :
                                </div>
                                <div class="col-md-2 padding-0">
                                    <input type="text" class="form-control input-sm" id="dateBulk">
                                    <datalist id="ClientMasterSearch"></datalist>
                                </div>
                                <div class="col-md-2 padding-0">
                                </div>
                                <div class="col-md-2 padding-0" style="text-align:right;">
                                    Exch / Seg :
                                </div>
                                <div class="col-md-2 padding-0">
                                    <select id='cmbDPID' class="form-control input-sm">
                                        <option value='ABC'>BSECASH</option>
                                        <option value='ANC'>NSECASH</option>
                                        <option value='AMC'>MCXCASH</option>
                                        <option value='ABF'>BSEFO</option>
                                        <option value='ANF'>NSEFO</option>
                                        <option value='AMF'>MCXFO</option>
                                        <option value='ABK'>BSEFX</option>
                                        <option value='ANK'>NSEFX</option>
                                        <option value='AMK'>MCXFX</option>
                                    </select>
                                </div>
                                <div class="col-md-1 padding-0">
                                </div>
                            </div>
                            <div class="form-group form-group-sm">
                                <div class="col-md-1 padding-0">
                                </div>
                                <div class="col-md-2 padding-0" style="text-align:right">
                                    Format :
                                </div>
                                <div class="col-md-3 padding-0">
                                    <select id='cmbFormat' class="form-control input-sm">
                                        <option value='0'>Deduct Debit</option>
                                        <option value='1'>Adjust Credit Against Debit</option>
                                    </select>
                                </div>
                                <div class="col-md-1 padding-0">
                                </div>
                                <div class="col-md-2 padding-0" style="text-align:right;">
                                    Order By :
                                </div>
                                <div class="col-md-2 padding-0">
                                    <select id='cmbSelect' class="form-control input-sm">
                                        <option value='CL'>Client</option>
                                        <option value='BR'>Branch</option>
                                        <option value='FM'>Family</option>
                                        <option value='GR'>Group</option>
                                    </select>
                                </div>
                                <div class="col-md-1 padding-0">
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="panel-footer" align="center">
                    <input type="button" value="Fetch" id="btnFetch" class="btn btn-primary input-sm" />
                </div>
            </div>

        </div>
        <div class="col-md-2"></div>
    </div>

    <div class="row">
        <div class="col-md-*">
            <div class="panel-group">
                <div id="divBulkPayoutReport" class="panel-body collapse">
                    <div style="font-family:Verdana; font-size:11px" id="example-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts
{

    <script src="~/AdminLTE/tabulator-master/dist/js/tabulator.min.js" type="text/javascript"></script>

    <script type="text/javascript">

        $(document).ready(function () {
            var table;

            $('#dateBulk').datepicker({
                format: 'dd/mm/yyyy',
                autoclose: true,
                startDate: "-365d",
                endDate: "+0d",
                todayHighlight: true,
            });
            $('#dateBulk').val(GetFormattedDate);
            $('#dateBulk').datepicker('update');
        });

        function GetFormattedDate() {
            var d = new Date();
            var day = ("0" + d.getDate()).slice(-2);
            var month = ("0" + (d.getMonth() + 1)).slice(-2);
            var year = d.getFullYear();
            return day + "/" + month + "/" + year;
        }

        $('#cmbSelect').change(function () {
            var value = this.value;
            var search = "";
            if (value == "ALL") {
                $("#txtSearchbyName").hide();
            }
            else if (value == "CL") {
                search = "Search For Client"
                $("#txtSearchbyName").show();
            }
            else if (value == "FM") {
                search = "Search For Family"
                $("#txtSearchbyName").show();
            }
            else if (value == "GR") {
                search = "Search For Group"
                $("#txtSearchbyName").show();
            }
            else if (value == "BR") {
                search = "Search For Branch"
                $("#txtSearchbyName").show();
            }
            else if (value == "SB") {
                search = "Search For SubBrokers"
                $("#txtSearchbyName").show();
            }
            else 
            $('#txtSearchbyName').val('');
            $('#txtSearchbyName').attr("placeholder", search);
        });

        $('#txtSearchbyName').on("input", function () {
            if ($('#txtSearchbyName').val() == "") {
                return;
            }
            var searchby = $('#cmbSelect').val();
            var options = {};
            options.url = '@Url.Action("GetClientDetails", "Tplus")';
            options.type = "GET";
            options.data = { 'criteria': $('#txtSearchbyName').val(), 'SearchBy': searchby };
            options.dataType = "json";
            options.success = function (data) {
                $("#ClientMasterSearch").empty();
                for (var i = 0; i < data.length; i++) {
                    $('#ClientMasterSearch').append("<option value='" +
                            data[i].ClientName + "'></option>");
                }
            };
            $.ajax(options);
        });

        $(document).on('click', '#btnFetch', function (event) {
            $('#divBulkPayoutReport').hide();
            var dpid = $('#cmbDPID').val();
            var format = $('#cmbFormat').val();
            var select = $('#cmbSelect').val();
            var Code = "";
            var valNew = $('#txtSearchbyName').val();
            if (valNew.trim() != "") {
                valNew = $('#txtSearchbyName').val().split("~");
                Code = valNew[1]
            }
            var date = $('#dateBulk').val();

            $.ajax({
                type: "GET",
                url: '@Url.Action("BulkPayoutReport", "Tplus")',
                dataType: "json",
                data: { 'DPID': dpid, 'strDt': date, 'format': format, 'type': select, 'code': Code },
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    $(".modal").show();
                },
                success: function (data) {
                    var minValueReq = function (cell, value, parameters) {
                        var curvalue = value;
                        var minamt = cell.getData()["Minamt"];
                        if (curvalue <= minamt) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }

                    table = new Tabulator("#example-table", {
                        height: "311px",
                        placeholder: "No Data Set",
                        data: data,
                        tooltips: true,
                        movableColumns: true,      //allow column order to be changed
                        resizableRows: true,       //allow row order to be changed
                        responsiveLayout: "hide",  //hide columns that dont fit on the table
                        footerElement: "<button class='btn btn-primary input-sm' id='btnSavePayout'>Save</button>", //add a custom button to the footer element
                        columns: [
                            { title: "Code", field: "Code", sorter: "string", width: 80 },
                            { title: "Name", field: "Name", sorter: "string", width: 500 },
                            { title: "DPID", field: dpid, visible: false, sorter: "string", width: 350 },
                            { title: "Date", field: date, visible: false, sorter: "string", width: 350 },
                            { title: "Due", field: "Amt2", align: "right", sorter: "number", width: 120, formatter: "money" },
                            { title: "Blocked", field: "Otheramt", sorter: "number", align: "right", width: 120, formatter: "money" },
                            {
                                title: "Payable", field: "Minamt", sorter: "number", align: "right", width: 120, formatter: "money",
                                cellClick: function (e, cell) {
                                    var minamt = cell.getData()["Minamt"];
                                    var Reqamt = cell.getData()["Amount"];
                                    if (minamt == Reqamt) {
                                        cell.getRow().update({ Amount: 0.00 })
                                    }
                                    else {
                                        cell.getRow().update({ Amount: minamt })
                                    }
                                },
                                tooltip: true,
                                tooltipGenerationMode: "hover",
                                tooltip: function (cell) {
                                    //cell - cell component
                                    //function should return a string for the tooltip of false to hide the tooltip
                                    return "CLICK TO UPDATE REQUEST VALUE SAME AS PAYABLE"; //return cells "field - value";
                                },
                            },
                            {
                                title: "<input id='select-all' type='checkbox'/> Request", field: "Amount", headerSort: false, align: "right", width: 120, formatter: "money", editor: true, bottomCalc: "sum", bottomCalcParams: { precision: 2 },
                                validator: minValueReq
                            },
                        ],
                    });

                    $(document).on('click', '#select-all', function (event) {
                        var isChecked = $(this).prop("checked");
                        if (isChecked) {
                            var cols = table.getData();
                            for (var i = 0; i < cols.length; i++) {
                                var code = cols[i].Code;
                                var amount = cols[i].Amount;
                                var payable = cols[i].Minamt;
                                cols[i].Amount = cols[i].Minamt;
                            }
                            table.setData(cols);
                        }
                        else {
                            var cols = table.getData();
                            for (var i = 0; i < cols.length; i++) {
                                var code = cols[i].Code;
                                var amount = cols[i].Amount;
                                var payable = cols[i].Minamt;
                                cols[i].Amount = 0;
                            }
                            table.setData(cols);
                        }
                    });
                },
                complete: function () {
                    $(".modal").hide();
                    $('#divBulkPayoutReport').show();
                },
                failure: function (errMsg) {
                    alert(errMsg);
                },
                error: function (response) {
                    alert(response.responseText);
                }
            });
        });

        $(document).on('click', "#btnSavePayout", function (event) {

            var ulist = new Array();
            ulist = table.getData();

            var dpid = $('#cmbDPID').val();
            var date = $('#dateBulk').val();

            var data = JSON.stringify({
                'ulist': ulist,
                'strDate': date,
                'strDpid': dpid
            });

            $.ajax({
                type: "POST",
                url: '@Url.Action("BulkPayoutSave", "Tplus")',
                dataType: "json",
                data: data,
                contentType: "application/json; charset=utf-8",
                success: function (rec) {
                    $('#divBulkPayoutReport').hide();
                },
                failure: function (errMsg) {
                    alert(errMsg);
                }
            });


        });
    </script>
}